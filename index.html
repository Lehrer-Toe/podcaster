<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Podcast Aufnahme – WebM mit Supabase</title>

  <!-- JSZip & FileSaver für „Alles herunterladen" -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      color: #333;
    }
    header {
      background: #4CAF50;
      color: #fff;
      padding: 1rem;
      text-align: center;
    }
    .container {
      max-width: 600px;
      margin: 2rem auto;
      background: #fff;
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h1 {
      margin-top: 0;
      font-size: 1.5rem;
    }
    .record-controls {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    input[type="text"] {
      padding: 0.4rem;
      flex: 1;
    }
    select {
      padding: 0.4rem;
    }
    button {
      padding: 0.6rem 1rem;
      font-size: 1rem;
      margin: 0.3rem;
      cursor: pointer;
      border: none;
      border-radius: 4px;
      background: #4CAF50;
      color: #fff;
      transition: background 0.2s ease;
    }
    button:hover {
      background: #45a049;
    }
    button:disabled {
      background: #cccccc;
      cursor: not-allowed;
    }
    audio {
      width: 100%;
      margin: 1rem 0;
    }
    #uploadStatus {
      margin: 1rem 0;
      font-weight: bold;
    }
    .visualizer-container {
      position: relative;
      width: 200px;
      height: 200px;
      margin: 20px auto 40px auto;
      border: 2px solid #ccc;
      border-radius: 8px;
      background: #fafafa;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .visualizer-circle {
      position: absolute;
      width: 40px;
      height: 40px;
      background: #f44336;
      border-radius: 50%;
      transition: width 0.1s, height 0.1s;
    }
    #timerDisplay {
      text-align: center;
      font-size: 1.2rem;
      font-weight: bold;
      margin-bottom: 1rem;
    }
    .file-list, .admin-panel {
      margin-top: 2rem;
    }
    .file-list h2, .admin-panel h2 {
      margin-bottom: 0.5rem;
    }
    .file-list ul, .admin-panel ul {
      list-style: none;
      padding-left: 0;
      margin: 0;
    }
    .file-list li, .admin-panel li {
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .file-list a, .admin-panel a {
      color: #4CAF50;
      text-decoration: none;
    }
    .file-list a:hover, .admin-panel a:hover {
      text-decoration: underline;
    }
    .admin-panel {
      display: none;
      border-top: 1px solid #ccc;
      padding-top: 1rem;
      margin-top: 2rem;
    }
    .admin-panel button.delete {
      background: #d9534f;
    }
    .admin-panel button.delete:hover {
      background: #c9302c;
    }
    .recording-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #f44336;
      margin-right: 8px;
      animation: blink 1s infinite;
    }
    @keyframes blink {
      0% { opacity: 1; }
      50% { opacity: 0.3; }
      100% { opacity: 1; }
    }
    .status-bar {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
    }
    .status-icon {
      margin-right: 5px;
    }
    .audio-format-control {
      display: flex;
      margin-bottom: 1rem;
      align-items: center;
    }
    .audio-format-control label {
      margin-right: 1rem;
    }
    .tab-container {
      margin-top: 2rem;
    }
    .tab-buttons {
      display: flex;
      border-bottom: 1px solid #ccc;
    }
    .tab-button {
      background: #e9e9e9;
      border: none;
      padding: 10px 20px;
      margin-right: 5px;
      border-radius: 5px 5px 0 0;
      cursor: pointer;
    }
    .tab-button.active {
      background: #4CAF50;
      color: white;
    }
    .tab-content {
      display: none;
      padding: 20px 10px;
    }
    .tab-content.active {
      display: block;
    }
    .pulse {
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.4); }
      70% { box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); }
      100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
    }
    #pauseBtn {
      background: #FF9800;
    }
    #pauseBtn:hover {
      background: #F57C00;
    }
    #resumeBtn {
      background: #2196F3;
    }
    #resumeBtn:hover {
      background: #1976D2;
    }
    .error-message {
      color: #d9534f;
      font-weight: bold;
    }
    .success-message {
      color: #4CAF50;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <header>
    <h1>Podcast Aufnahme – Audio Recorder</h1>
  </header>

  <div class="container">
    <!-- Aufnahme-Steuerung -->
    <div class="record-controls">
      <input type="text" id="filename" placeholder="Dateiname (Pflicht!)" />
      <button id="startBtn" disabled>Aufnahme starten</button>
      <button id="pauseBtn" disabled>Pausieren</button>
      <button id="resumeBtn" disabled>Fortsetzen</button>
      <button id="stopBtn" disabled>Stoppen</button>
      <button id="uploadBtn" disabled>Hochladen</button>
    </div>

    <!-- Audio-Format Auswahl -->
    <div class="audio-format-control">
      <label for="audioFormat">Audio-Format:</label>
      <select id="audioFormat">
        <option value="audio/webm">WebM (Standard)</option>
        <option value="audio/ogg;codecs=opus">Ogg Opus</option>
        <option value="audio/mpeg">MP3 (falls unterstützt)</option>
      </select>
    </div>

    <!-- Status-Anzeige -->
    <div class="status-bar">
      <span id="recordingStatus"></span>
    </div>

    <!-- Timer-Anzeige -->
    <div id="timerDisplay">00:00</div>

    <!-- Audio-Vorschau & Status -->
    <audio id="audioPlayer" controls></audio>
    <p id="uploadStatus"></p>

    <!-- Visueller Lautstärke-Indikator -->
    <div class="visualizer-container">
      <div class="visualizer-circle" id="visualizerCircle"></div>
    </div>

    <!-- Tab-Navigation -->
    <div class="tab-container">
      <div class="tab-buttons">
        <button class="tab-button active" data-tab="recordings">Aufnahmen</button>
        <button class="tab-button" data-tab="help">Hilfe</button>
      </div>
      
      <!-- Aufnahmen Tab -->
      <div class="tab-content active" id="recordings-tab">
        <!-- Öffentliche Dateiliste -->
        <div class="file-list">
          <h2>Vorhandene Aufnahmen:</h2>
          <ul id="fileList"></ul>
        </div>
      </div>
      
      <!-- Hilfe Tab -->
      <div class="tab-content" id="help-tab">
        <h2>Verwendung:</h2>
        <ol>
          <li>Geben Sie einen Dateinamen ein</li>
          <li>Wählen Sie das gewünschte Audioformat</li>
          <li>Klicken Sie auf "Aufnahme starten"</li>
          <li>Sie können die Aufnahme pausieren und fortsetzen</li>
          <li>Nach dem Stoppen können Sie die Aufnahme anhören</li>
          <li>Klicken Sie auf "Hochladen", um die Aufnahme zu speichern</li>
        </ol>
        <p><strong>Hinweis:</strong> Ihr Browser speichert die letzte Aufnahme lokal. Sie können die Seite neu laden, ohne die Aufnahme zu verlieren.</p>
      </div>
    </div>

    <!-- Admin-Oberfläche -->
    <div class="admin-panel" id="adminPanel">
      <h2>Admin-Oberfläche</h2>
      <button id="downloadAllBtn" style="background:#555;">Alles herunterladen</button>
      <ul id="adminFileList"></ul>
      <button id="closeAdminBtn" style="background:#333;">Admin schließen</button>
    </div>

    <!-- Admin-Login Button -->
    <button id="adminLoginBtn" style="background:#333;">Admin Login</button>
  </div>

  <!-- Supabase (ES-Modul) -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

    // --- 1) SUPABASE KONFIG --- 
    // Diese Werte sollten idealerweise über eine Server-Umgebungsvariable kommen
    // Hier nur für Demo-Zwecke im Client - für Produktion nicht empfohlen
    const SUPABASE_URL = "https://DEINE-URL.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6bXpscnNmdWVwYmtxd3picmlyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDE5NTkxMzAsImV4cCI6MjA1NzUzNTEzMH0.zLZDSfylloUxlxYPEpfO4VMAdf0cNpUzKH2T9qv8ezI";
    
    // Initialisiere Supabase Client
    let supabaseClient;
    try {
      supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      console.log("Supabase Client erfolgreich initialisiert");
    } catch (err) {
      console.error("Fehler bei der Supabase-Initialisierung:", err);
      showError("Verbindungsfehler: Bitte später erneut versuchen.");
    }

    // --- 2) Variablen ---
    let mediaRecorder;
    let audioStream;
    let audioChunks = [];
    let currentRecordingBlob = null;
    let audioContext, analyser, dataArray, animationId;
    let recordingTime = 0;
    let recordingInterval = null;
    let isPaused = false;
    let isRecording = false;
    
    // Für die Anwendungseinstellungen
    const appSettings = {
      adminLoggedIn: false,
      lastFormat: localStorage.getItem('preferredFormat') || 'audio/webm',
      lastFileName: localStorage.getItem('lastFileName') || ''
    };

    // --- 3) DOM-Elemente ---
    const filenameInput    = document.getElementById("filename");
    const startBtn         = document.getElementById("startBtn");
    const pauseBtn         = document.getElementById("pauseBtn");
    const resumeBtn        = document.getElementById("resumeBtn");
    const stopBtn          = document.getElementById("stopBtn");
    const uploadBtn        = document.getElementById("uploadBtn");
    const audioPlayer      = document.getElementById("audioPlayer");
    const uploadStatus     = document.getElementById("uploadStatus");
    const fileList         = document.getElementById("fileList");
    const adminPanel       = document.getElementById("adminPanel");
    const adminFileList    = document.getElementById("adminFileList");
    const adminLoginBtn    = document.getElementById("adminLoginBtn");
    const closeAdminBtn    = document.getElementById("closeAdminBtn");
    const visualizerCircle = document.getElementById("visualizerCircle");
    const downloadAllBtn   = document.getElementById("downloadAllBtn");
    const timerDisplay     = document.getElementById("timerDisplay");
    const recordingStatus  = document.getElementById("recordingStatus");
    const audioFormat      = document.getElementById("audioFormat");
    const tabButtons       = document.querySelectorAll(".tab-button");
    const tabContents      = document.querySelectorAll(".tab-content");

    // --- 4) Initialisierung ---
    function init() {
      // Lade gespeicherte Einstellungen aus dem LocalStorage
      if (appSettings.lastFileName) {
        filenameInput.value = appSettings.lastFileName;
        validateFileName();
      }
      
      if (appSettings.lastFormat) {
        audioFormat.value = appSettings.lastFormat;
      }
      
      // Prüfe Browser-Unterstützung
      checkBrowserSupport();
      
      // Lade vorhandene Dateien
      loadFiles();
      
      // Setze Event Listeners
      setupEventListeners();
      
      // Prüfe, ob es eine gespeicherte Aufnahme gibt
      checkForSavedRecording();
    }

    // --- 5) Browser-Unterstützung prüfen ---
    function checkBrowserSupport() {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        showError("Ihr Browser unterstützt keine Audioaufnahmen. Bitte verwenden Sie einen modernen Browser wie Chrome, Firefox oder Edge.");
        startBtn.disabled = true;
        return false;
      }
      return true;
    }

    // --- 6) Event Listeners ---
    function setupEventListeners() {
      // Dateiname-Validierung
      filenameInput.addEventListener("input", validateFileName);
      
      // Format-Änderung
      audioFormat.addEventListener("change", () => {
        localStorage.setItem('preferredFormat', audioFormat.value);
      });
      
      // Aufnahme-Steuerung
      startBtn.addEventListener("click", startRecording);
      pauseBtn.addEventListener("click", pauseRecording);
      resumeBtn.addEventListener("click", resumeRecording);
      stopBtn.addEventListener("click", stopRecording);
      uploadBtn.addEventListener("click", uploadRecording);
      
      // Admin-Bereich
      adminLoginBtn.addEventListener("click", handleAdminLogin);
      closeAdminBtn.addEventListener("click", () => {
        adminPanel.style.display = "none";
        appSettings.adminLoggedIn = false;
      });
      downloadAllBtn.addEventListener("click", downloadAllFiles);
      
      // Tab-Navigation
      tabButtons.forEach(button => {
        button.addEventListener("click", () => {
          const tabId = button.dataset.tab;
          
          // Aktiven Tab wechseln
          tabButtons.forEach(btn => btn.classList.remove("active"));
          tabContents.forEach(content => content.classList.remove("active"));
          
          button.classList.add("active");
          document.getElementById(`${tabId}-tab`).classList.add("active");
        });
      });

      // Dateiliste Löschen (nur für Admin)
      adminFileList.addEventListener("click", handleAdminFileAction);
    }

    // --- 7) Dateiname-Validierung ---
    function validateFileName() {
      const filename = filenameInput.value.trim();
      
      if (filename) {
        startBtn.disabled = false;
        localStorage.setItem('lastFileName', filename);
      } else {
        startBtn.disabled = true;
      }
    }

    // --- 8) Aufnahme starten ---
    async function startRecording() {
      const filename = filenameInput.value.trim();
      
      if (!filename) {
        showError("Bitte erst einen Dateinamen eingeben!");
        return;
      }
      
      if (!checkBrowserSupport()) return;
      
      try {
        // Audiostream anfordern
        audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        // Prüfe, ob das gewählte Format unterstützt wird
        const selectedFormat = audioFormat.value;
        const options = { mimeType: selectedFormat };
        
        // Prüfe, ob das Format unterstützt wird
        if (!MediaRecorder.isTypeSupported(selectedFormat)) {
          showWarning(`Format ${selectedFormat} wird nicht unterstützt. Fallback auf WebM.`);
          options.mimeType = "audio/webm";
          audioFormat.value = "audio/webm";
        }
        
        // MediaRecorder initialisieren
        mediaRecorder = new MediaRecorder(audioStream, options);
        audioChunks = [];
        
        // Event Handling
        mediaRecorder.ondataavailable = handleDataAvailable;
        mediaRecorder.onstop = handleRecordingStop;
        mediaRecorder.onpause = handleRecordingPause;
        mediaRecorder.onresume = handleRecordingResume;
        mediaRecorder.onerror = (event) => {
          showError("Aufnahmefehler: " + event.error);
        };
        
        // Aufnahme starten
        mediaRecorder.start(1000); // Chunks alle 1 Sekunde
        isRecording = true;
        isPaused = false;
        
        // UI aktualisieren
        updateRecordingUI(true);
        
        // Visualizer und Timer starten
        startVisualizer(audioStream);
        startTimer();
        
        showMessage("Aufnahme läuft...", true);
      } catch (err) {
        showError("Mikrofon-Zugriff nicht erlaubt oder nicht verfügbar.");
        console.error("Aufnahmefehler:", err);
      }
    }
    
    // --- 9) Aufnahme pausieren ---
    function pauseRecording() {
      if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.pause();
        isPaused = true;
        pauseTimer();
        pauseVisualizer();
        updateRecordingUI(true, true);
        showMessage("Aufnahme pausiert", false);
      }
    }
    
    // --- 10) Aufnahme fortsetzen ---
    function resumeRecording() {
      if (mediaRecorder && mediaRecorder.state === "paused") {
        mediaRecorder.resume();
        isPaused = false;
        resumeTimer();
        resumeVisualizer();
        updateRecordingUI(true, false);
        showMessage("Aufnahme fortgesetzt", true);
      }
    }

    // --- 11) Aufnahme stoppen ---
    function stopRecording() {
      if (mediaRecorder && (mediaRecorder.state === "recording" || mediaRecorder.state === "paused")) {
        mediaRecorder.stop();
        isRecording = false;
        isPaused = false;
        
        if (audioStream) {
          audioStream.getTracks().forEach(track => track.stop());
        }
        
        stopTimer();
        stopVisualizer();
        updateRecordingUI(false);
      }
    }

    // --- 12) Media Recorder Event Handler ---
    function handleDataAvailable(event) {
      if (event.data && event.data.size > 0) {
        audioChunks.push(event.data);
        // Speichere den aktuellen Stand im LocalStorage
        saveRecordingChunks();
      }
    }
    
    function handleRecordingStop() {
      // Erstelle Blob aus gesammelten Daten
      const mimeType = audioFormat.value;
      currentRecordingBlob = new Blob(audioChunks, { type: mimeType });
      
      // Audio-Player aktualisieren
      const audioUrl = URL.createObjectURL(currentRecordingBlob);
      audioPlayer.src = audioUrl;
      
      // UI aktualisieren
      uploadBtn.disabled = false;
      showMessage("Aufnahme bereit – bitte jetzt anhören und hochladen.", false);
      
      // Lokale Kopie speichern
      saveRecording(currentRecordingBlob, mimeType);
    }
    
    function handleRecordingPause() {
      showMessage("Aufnahme pausiert", false);
    }
    
    function handleRecordingResume() {
      showMessage("Aufnahme fortgesetzt", true);
    }

    // --- 13) Aufnahme hochladen ---
    async function uploadRecording() {
      if (!currentRecordingBlob) {
        showError("Keine Aufnahme vorhanden!");
        return;
      }
      
      showMessage("Wird hochgeladen...", false);
      uploadBtn.disabled = true;
      
      // Dateinamen vorbereiten
      let baseName = filenameInput.value.trim();
      const mimeType = audioFormat.value;
      let extension;
      
      // Dateiendung basierend auf MIME-Typ festlegen
      switch (mimeType) {
        case "audio/webm":
          extension = ".webm";
          break;
        case "audio/ogg;codecs=opus":
          extension = ".ogg";
          break;
        case "audio/mpeg":
          extension = ".mp3";
          break;
        default:
          extension = ".webm";
      }
      
      // Dateinamen mit Endung erstellen
      const fileName = baseName + extension;
      
      try {
        // Auf Supabase hochladen
        const { error } = await supabaseClient
          .storage
          .from('podcast-audio')
          .upload(fileName, currentRecordingBlob, { contentType: mimeType });
        
        if (error) {
          throw error;
        }
        
        // Erfolgsmeldung
        showSuccess("✅ Erfolgreich hochgeladen: " + fileName);
        currentRecordingBlob = null;
        
        // Lokale Aufnahme löschen
        clearSavedRecording();
        
        // Dateiliste aktualisieren
        loadFiles();
      } catch (error) {
        console.error("Upload-Fehler:", error);
        showError("❌ Fehler beim Upload: " + error.message);
        uploadBtn.disabled = false;
      }
    }

    // --- 14) Öffentliche Dateiliste laden ---
    async function loadFiles() {
      fileList.innerHTML = "<li>Dateien werden geladen...</li>";
      
      try {
        const { data, error } = await supabaseClient.storage
          .from('podcast-audio')
          .list('', { limit: 100, offset: 0, sortBy: { column: 'created_at', order: 'desc' } });
        
        if (error) {
          throw error;
        }
        
        fileList.innerHTML = "";
        
        if (!data || data.length === 0) {
          fileList.innerHTML = "<li>Keine Aufnahmen vorhanden</li>";
          return;
        }
        
        for (const file of data) {
          const { data: publicUrl } = supabaseClient
            .storage
            .from('podcast-audio')
            .getPublicUrl(file.name);
          
          const li = document.createElement('li');
          li.innerHTML = `
            <a href="${publicUrl.publicUrl}" target="_blank" download="${file.name}">
              ${file.name}
            </a>
            <span>(${formatBytes(file.metadata?.size || 0)})</span>
          `;
          fileList.appendChild(li);
        }
      } catch (err) {
        console.error("Fehler beim Laden der Dateien:", err);
        fileList.innerHTML = "<li class='error-message'>Fehler beim Laden der Dateien</li>";
      }
    }

    // --- 15) Admin-Bereich ---
    function handleAdminLogin() {
      // WARNUNG: In Produktion sollte das Passwort nicht im Client-Code sein
      // Besser: Server-seitige Authentifizierung
      const storedHash = localStorage.getItem('adminHash');
      
      if (storedHash) {
        // Hash aus LocalStorage verwenden (Nutzer bereits angemeldet)
        const pwd = prompt("Bitte Admin-Passwort eingeben:");
        
        if (pwd && hashPassword(pwd) === storedHash) {
          showAdminPanel();
        } else {
          alert("Falsches Passwort!");
        }
      } else {
        // Neues Passwort speichern (Demo-Zwecke)
        const pwd = prompt("Bitte Admin-Passwort eingeben:");
        
        if (pwd === "Luna") {
          // Passwort hashen und im LocalStorage speichern
          localStorage.setItem('adminHash', hashPassword(pwd));
          showAdminPanel();
        } else {
          alert("Falsches Passwort!");
        }
      }
    }
    
    function showAdminPanel() {
      adminPanel.style.display = "block";
      appSettings.adminLoggedIn = true;
      loadAdminFiles();
    }
    
    // Einfache Hash-Funktion (nur für Demo, nicht sicher!)
    function hashPassword(password) {
      let hash = 0;
      for (let i = 0; i < password.length; i++) {
        hash = ((hash << 5) - hash) + password.charCodeAt(i);
        hash = hash & hash; // Convert to 32bit integer
      }
      return hash.toString(16);
    }

    // --- 16) Admin-Dateien laden ---
    async function loadAdminFiles() {
      adminFileList.innerHTML = "<li>Dateien werden geladen...</li>";
      
      try {
        const { data, error } = await supabaseClient.storage
          .from('podcast-audio')
          .list('', { limit: 100, offset: 0, sortBy: { column: 'created_at', order: 'desc' } });
        
        if (error) {
          throw error;
        }
        
        adminFileList.innerHTML = "";
        
        if (!data || data.length === 0) {
          adminFileList.innerHTML = "<li>Keine Aufnahmen vorhanden</li>";
          return;
        }
        
        for (const file of data) {
          const { data: publicUrl } = supabaseClient
            .storage
            .from('podcast-audio')
            .getPublicUrl(file.name);
          
          const li = document.createElement('li');
          li.innerHTML = `
            <a href="${publicUrl.publicUrl}" target="_blank">${file.name}</a>
            <span>(${formatBytes(file.metadata?.size || 0)})</span>
            <button class="delete" data-filename="${file.name}">Löschen</button>
          `;
          adminFileList.appendChild(li);
        }
      } catch (err) {
        console.error("Fehler beim Laden der Admin-Dateien:", err);
        adminFileList.innerHTML = "<li class='error-message'>Fehler beim Laden der Dateien</li>";
      }
    }

    // --- 17) Admin-Dateiaktionen ---
    async function handleAdminFileAction(e) {
      if (!e.target.classList.contains("delete")) return;
      
      const fileName = e.target.getAttribute("data-filename");
      
      if (!confirm(`Sind Sie sicher, dass Sie die Datei "${fileName}" löschen möchten?`)) {
        return;
      }
      
      try {
        const { error } = await supabaseClient
          .storage
          .from('podcast-audio')
          .remove([fileName]);
          
        if (error) {
          throw error;
        }
        
        showSuccess(`Datei '${fileName}' wurde gelöscht.`);
        loadFiles();
        loadAdminFiles();
      } catch (err) {
        showError("Fehler beim Löschen: " + err.message);
      }
    }

    // --- 18) Alles herunterladen (ZIP) ---
    async function downloadAllFiles() {
      showMessage("ZIP-Datei wird vorbereitet...", false);