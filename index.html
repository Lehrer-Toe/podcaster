<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Schul-Podcaster</title>
  <style>
    /* --- Allgemeine Styles --- */
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: #f4f4f4;
      color: #333;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }
    
    /* --- Header --- */
    header {
      background: #4CAF50;
      color: #fff;
      padding: 1.5rem;
      text-align: center;
      box-shadow: 0 2px 15px rgba(0,0,0,0.1);
      position: relative;
    }
    
    .version {
      position: absolute;
      right: 10px;
      top: 10px;
      font-size: 0.8rem;
      opacity: 0.8;
    }
    
    /* --- Container --- */
    .container {
      max-width: 700px;
      margin: 2rem auto;
      background: #fff;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.06);
    }
    
    @media (max-width: 768px) {
      .container {
        margin: 1rem;
        padding: 1.5rem;
      }
    }
    
    h1 {
      margin-top: 0;
      font-size: 1.8rem;
      font-weight: 600;
    }
    
    h2 {
      font-size: 1.4rem;
      margin-bottom: 1rem;
      color: #4caf50;
    }
    
    /* --- Teacher Selection --- */
    .teacher-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-top: 2rem;
    }
    
    .teacher-card {
      background: #fff;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 1.5rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .teacher-card:hover {
      border-color: #4CAF50;
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    
    .teacher-card img {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      margin-bottom: 1rem;
      object-fit: cover;
      background-color: #f0f0f0;
    }
    
    .teacher-card h3 {
      margin: 0.5rem 0;
      color: #333;
    }
    
    .teacher-card p {
      color: #666;
      margin-bottom: 0;
    }
    
    .teacher-info {
      margin-bottom: 2rem;
      padding: 1rem;
      background: #f9f9f9;
      border-radius: 8px;
      text-align: center;
    }
    
    .teacher-info img {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      margin-right: 1rem;
      vertical-align: middle;
      background-color: #f0f0f0;
    }
    
    .teacher-info h3 {
      display: inline-block;
      margin: 0;
      vertical-align: middle;
    }
    
    .back-button {
      background: #607D8B;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      margin-bottom: 1rem;
      display: inline-flex;
      align-items: center;
    }
    
    .back-button:hover {
      background: #546E7A;
    }
    
    .back-button::before {
      content: "←";
      margin-right: 8px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Schul-Podcaster</h1>
    <div class="version">v4.0</div>
  </header>

  <div class="container">
    <div id="teacher-selection-page">
      <h2>Bitte wählen Sie einen Lehrer aus</h2>
      <p>Um mit der Aufnahme zu beginnen, klicken Sie auf den entsprechenden Lehrer.</p>
      
      <div class="teacher-grid">
        <div class="teacher-card" data-code="TOE" data-name="Töllner">
          <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23e0e0e0'/%3E%3Ctext x='50' y='60' font-family='Arial' font-size='30' text-anchor='middle' fill='%23666'%3ET%3C/text%3E%3C/svg%3E" alt="Töllner">
          <h3>Herr Töllner</h3>
          <p>Deutsch, Geschichte</p>
        </div>
        
        <div class="teacher-card" data-code="SEU" data-name="Seuffert">
          <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23e0e0e0'/%3E%3Ctext x='50' y='60' font-family='Arial' font-size='30' text-anchor='middle' fill='%23666'%3ES%3C/text%3E%3C/svg%3E" alt="Seuffert">
          <h3>Frau Seuffert</h3>
          <p>Mathematik, Physik</p>
        </div>
        
        <div class="teacher-card" data-code="LOZ" data-name="Lozano">
          <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23e0e0e0'/%3E%3Ctext x='50' y='60' font-family='Arial' font-size='30' text-anchor='middle' fill='%23666'%3EL%3C/text%3E%3C/svg%3E" alt="Lozano">
          <h3>Herr Lozano</h3>
          <p>Spanisch, Englisch</p>
        </div>
        
        <div class="teacher-card" data-code="HEI" data-name="Heiler">
          <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23e0e0e0'/%3E%3Ctext x='50' y='60' font-family='Arial' font-size='30' text-anchor='middle' fill='%23666'%3EH%3C/text%3E%3C/svg%3E" alt="Heiler">
          <h3>Frau Heiler</h3>
          <p>Biologie, Chemie</p>
        </div>
      </div>
    </div>
    
    <div id="podcast-recorder-page" style="display:none;">
      <!-- Podcast-App wird hier dynamisch eingefügt -->
    </div>
  </div>

  <!-- Starter Script to handle teacher selection -->
  <script>
    // Wenn ein Lehrer angeklickt wird
    document.querySelectorAll('.teacher-card').forEach(card => {
      card.addEventListener('click', function() {
        const teacherCode = this.getAttribute('data-code');
        const teacherName = this.getAttribute('data-name');
        
        // Speichere Lehrer-Daten im localStorage
        localStorage.setItem('selectedTeacherCode', teacherCode);
        localStorage.setItem('selectedTeacherName', teacherName);
        
        // Lade die Podcast-App
        loadPodcastApp();
      });
    });
    
    // Prüfe, ob bereits ein Lehrer ausgewählt wurde
    window.addEventListener('DOMContentLoaded', function() {
      const savedTeacherCode = localStorage.getItem('selectedTeacherCode');
      const savedTeacherName = localStorage.getItem('selectedTeacherName');
      
      if (savedTeacherCode && savedTeacherName) {
        // Automatisch zur Podcast-App weiterleiten
        loadPodcastApp();
      }
    });
    
    // Lädt die Podcast-App
    function loadPodcastApp() {
      // Blende Lehrer-Auswahl aus
      document.getElementById('teacher-selection-page').style.display = 'none';
      
      // Zeige Podcast-App an
      const podcastPage = document.getElementById('podcast-recorder-page');
      podcastPage.style.display = 'block';
      
      // Lade die Podcast-App (hier mit innerHTML)
      fetch('podcast-app.html')
        .then(response => {
          if (!response.ok) {
            // Da keine externe Datei existiert, fügen wir die App hier direkt ein
            insertPodcastApp();
          }
          return response.text();
        })
        .then(html => {
          podcastPage.innerHTML = html;
        })
        .catch(error => {
          console.log('Lade eingebettete App:', error);
          insertPodcastApp();
        });
    }
    
    // Fügt die Podcast-App direkt ein (als Fallback)
    function insertPodcastApp() {
      const teacherCode = localStorage.getItem('selectedTeacherCode') || '';
      const teacherName = localStorage.getItem('selectedTeacherName') || '';
      
      const podcastPage = document.getElementById('podcast-recorder-page');
      
      // Lehrer-Info am Anfang
      const teacherInfoHTML = `
        <div class="teacher-info">
          <button id="backToTeacherSelection" class="back-button">Zur Lehrerauswahl</button>
          <div>
            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23e0e0e0'/%3E%3Ctext x='50' y='60' font-family='Arial' font-size='30' text-anchor='middle' fill='%23666'%3E${teacherCode.charAt(0)}%3C/text%3E%3C/svg%3E" alt="${teacherName}">
            <h3>${teacherName}</h3>
          </div>
        </div>
      `;
      
      // Füge die App ein
      podcastPage.innerHTML = teacherInfoHTML + getPodcastAppHTML();
      
      // Event-Listener für Zurück-Button
      document.getElementById('backToTeacherSelection').addEventListener('click', function() {
        // Zurück zur Lehrer-Auswahl
        document.getElementById('teacher-selection-page').style.display = 'block';
        document.getElementById('podcast-recorder-page').style.display = 'none';
      });
      
      // Initialisiere die Podcast-App
      if (window.initPodcastApp) {
        window.initPodcastApp();
      }
    }
    
    // Die komplette Podcast-App als HTML-String
    function getPodcastAppHTML() {
      return `
        <style>
          /* --- Allgemeine Styles --- */
          * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
          }
          
          /* --- Aufnahme-Controls --- */
          .record-controls {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            margin-bottom: 1.5rem;
          }
          
          .filename-input-container {
            position: relative;
            margin-bottom: 0.5rem;
          }
          
          input[type="text"], input[type="password"] {
            width: 100%;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            transition: all 0.2s ease;
            -webkit-appearance: none;
            appearance: none;
          }
          
          input[type="text"]:focus, input[type="password"]:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);
          }
          
          .input-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #555;
          }
          
          /* --- Button Styles --- */
          button {
            padding: 0.75rem 1rem;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            color: #fff;
            transition: all 0.2s ease;
            -webkit-appearance: none;
            appearance: none;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 48px; /* Für bessere Touch-Ziele auf iPads */
          }
          
          button:active:not(:disabled) {
            transform: translateY(1px);
          }
          
          button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
          }
          
          button:focus {
            outline: none;
          }
          
          /* --- Button-Zeilen --- */
          .button-row {
            display: flex;
            gap: 0.8rem;
          }
          
          .button-row button {
            flex: 1;
          }
          
          /* --- Spezielle Button-Typen --- */
          #startBtn {
            background: #4CAF50;
          }
          
          #stopBtn {
            background: #f44336;
          }
          
          #pauseBtn, #resumeBtn {
            background: #ff9800;
          }
          
          #uploadBtn {
            background: #673AB7;
          }
          
          #clearStorageBtn {
            background: #607D8B;
          }
          
          /* --- Audio Format Info --- */
          .format-info {
            display: none; /* Format-Info verstecken, da für Schüler nicht relevant */
            background-color: #f0f8e6;
            border-radius: 8px;
            padding: 10px 15px;
            margin-bottom: 1rem;
            border-left: 4px solid #8bc34a;
          }
          
          /* --- Status-Anzeigen --- */
          .status-bar {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            padding: 0.5rem 0;
            min-height: 2rem;
          }
          
          #timerDisplay {
            text-align: center;
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: #4caf50;
          }
          
          /* --- Audio Player --- */
          audio {
            width: 100%;
            margin: 1.5rem 0;
            border-radius: 8px;
          }
          
          #uploadStatus {
            margin: 1rem 0;
            font-weight: 500;
            padding: 0.75rem;
            border-radius: 8px;
            background: #f5f5f5;
            min-height: 3rem;
            display: flex;
            align-items: center;
          }
          
          /* --- Visualizer --- */
          .visualizer-container {
            position: relative;
            width: 200px;
            height: 200px;
            margin: 20px auto 40px auto;
            border-radius: 50%;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid #f0f0f0;
          }
          
          .visualizer-circle {
            position: absolute;
            width: 40px;
            height: 40px;
            background: #f44336;
            border-radius: 50%;
            transition: width 0.1s, height 0.1s;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
          }
          
          /* --- Tabs --- */
          .tab-container {
            margin-top: 2.5rem;
          }
          
          .tab-buttons {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 1.5rem;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
          }
          
          .tab-button {
            background: #f0f0f0;
            border: none;
            padding: 0.75rem 1.5rem;
            margin-right: 0.5rem;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            color: #666;
            font-weight: 500;
            min-width: auto;
          }
          
          .tab-button.active {
            background: #4CAF50;
            color: white;
          }
          
          .tab-content {
            display: none;
            padding: 1rem 0;
          }
          
          .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
          }
          
          @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
          }
          
          /* --- Dateien-Liste --- */
          .file-list, .admin-panel {
            margin-top: 1rem;
          }
          
          .file-list h2, .admin-panel h2 {
            margin-bottom: 1rem;
            color: #4caf50;
          }
          
          .file-list ul, .admin-panel ul {
            list-style: none;
            padding-left: 0;
            margin: 0;
          }
          
          .file-list li, .admin-panel li {
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border-radius: 8px;
            background: #f8f9fa;
            transition: all 0.2s ease;
          }
          
          .file-list a, .admin-panel a {
            color: #4CAF50;
            text-decoration: none;
            flex: 1;
            padding: 0.25rem 0;
          }
          
          .file-list a:hover, .admin-panel a:hover {
            text-decoration: underline;
          }
          
          /* --- Admin Panel --- */
          .admin-panel {
            display: none;
            border-top: 1px solid #e0e0e0;
            padding-top: 1.5rem;
            margin-top: 2rem;
          }
          
          .admin-panel button.delete {
            background: #f44336;
            padding: 0.5rem 0.75rem;
            margin-left: 0.75rem;
            font-size: 0.9rem;
          }
          
          .admin-panel button.toggle-visibility {
            background: #2196F3;
            padding: 0.5rem 0.75rem;
            margin-left: 0.5rem;
            font-size: 0.9rem;
          }
          
          .admin-controls {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
          }
          
          #adminLoginBtn {
            background: #424242;
            margin-top: 2rem;
          }
          
          #closeAdminBtn {
            background: #424242;
          }
          
          /* --- Indikatoren und Animationen --- */
          .recording-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #f44336;
            margin-right: 8px;
            animation: blink 1s infinite;
          }
          
          @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
          }
          
          .status-icon {
            margin-right: 5px;
          }
          
          .error-message {
            color: #f44336;
            font-weight: 500;
          }
          
          .success-message {
            color: #4CAF50;
            font-weight: 500;
          }
          
          .file-size {
            color: #888;
            margin-left: 0.75rem;
            font-size: 0.9rem;
          }
          
          .file-visibility {
            display: flex;
            align-items: center;
            margin-left: 0.5rem;
          }
          
          .file-visibility-icon {
            margin-right: 0.25rem;
          }
          
          .public-file {
            background-color: #f1f8e9;
          }
          
          .private-file {
            background-color: #f8f9fa;
          }
          
          /* --- Password Modal --- */
          .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
          }
          
          .modal-content {
            background-color: #fff;
            margin: 15% auto;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            max-width: 400px;
            width: 90%;
          }
          
          .modal-title {
            margin-top: 0;
            color: #4caf50;
          }
          
          .modal-footer {
            margin-top: 1.5rem;
            display: flex;
            justify-content: flex-end;
            gap: 0.8rem;
          }
          
          /* iPad-spezifische Styles */
          @media (max-width: 1024px) and (-webkit-min-device-pixel-ratio: 2), 
                (max-width: 1024px) and (min-resolution: 192dpi) {
            button, input, select {
              font-size: 1.1rem;
              padding: 0.85rem 1rem;
            }
            
            h1 {
              font-size: 2rem;
            }
          }
        </style>

        <!-- Aufnahme-Steuerung -->
        <div class="record-controls">
          <div class="filename-input-container">
            <label for="filename" class="input-label">Schülername (Pflicht)</label>
            <input type="text" id="filename" placeholder="Schülername eingeben" autocomplete="off" />
          </div>

          <!-- Audio-Format Info -->
          <div class="format-info" id="formatInfo">
            Aktuelles Format: <span id="currentFormat">Wird ermittelt...</span>
          </div>

          <!-- Erste Zeile mit Start und Stopp Buttons -->
          <div class="button-row">
            <button id="startBtn">Aufnahme starten</button>
            <button id="stopBtn" disabled>Stoppen</button>
          </div>
          
          <!-- Zweite Zeile mit Pause und Fortsetzen Buttons -->
          <div class="button-row">
            <button id="pauseBtn" disabled>Pausieren</button>
            <button id="resumeBtn" disabled>Fortsetzen</button>
          </div>
          
          <!-- Dritte Zeile mit Upload Button -->
          <button id="uploadBtn" disabled>Hochladen</button>
          
          <!-- Vierte Zeile mit Speicher löschen Button -->
          <button id="clearStorageBtn">Lokalen Speicher löschen</button>
        </div>

        <!-- Status-Anzeige -->
        <div class="status-bar">
          <span id="recordingStatus"></span>
        </div>

        <!-- Timer-Anzeige -->
        <div id="timerDisplay">00:00</div>

        <!-- Visueller Lautstärke-Indikator -->
        <div class="visualizer-container">
          <div class="visualizer-circle" id="visualizerCircle"></div>
        </div>

        <!-- Audio-Vorschau & Status -->
        <audio id="audioPlayer" controls></audio>
        <p id="uploadStatus"></p>

        <!-- Tab-Navigation -->
        <div class="tab-container">
          <div class="tab-buttons">
            <button class="tab-button active" data-tab="recordings">Aufnahmen</button>
            <button class="tab-button" data-tab="help">Hilfe</button>
          </div>
          
          <!-- Aufnahmen Tab -->
          <div class="tab-content active" id="recordings-tab">
            <!-- Öffentliche Dateiliste -->
            <div class="file-list">
              <h2>Vorhandene Aufnahmen</h2>
              <ul id="fileList"></ul>
            </div>
          </div>
          
          <!-- Hilfe Tab -->
          <div class="tab-content" id="help-tab">
            <h2>Verwendung</h2>
            <ol>
              <li>Geben Sie Ihren Schülername ein</li>
              <li>Klicken Sie auf "Aufnahme starten"</li>
              <li>Sie können die Aufnahme pausieren und fortsetzen</li>
              <li>Nach dem Stoppen können Sie die Aufnahme anhören</li>
              <li>Klicken Sie auf "Hochladen", um die Aufnahme zu speichern</li>
            </ol>
            <p><strong>Hinweis:</strong> Ihr Browser speichert die letzte Aufnahme lokal. Sie können den lokalen Speicher mit dem "Lokalen Speicher löschen"-Button leeren.</p>
            
            <h3>Fehlerbehebung</h3>
            <ul>
              <li><strong>Mikrofon funktioniert nicht:</strong> Prüfen Sie die Browsereinstellungen und erteilen Sie die Berechtigung für den Mikrofonzugriff.</li>
              <li><strong>Aufnahme startet nicht:</strong> Stellen Sie sicher, dass ein Dateiname eingegeben wurde.</li>
              <li><strong>Probleme auf iOS:</strong> Starten Sie Safari neu oder verwenden Sie den Privatmodus, falls Sie Probleme haben.</li>
              <li><strong>Hochladen funktioniert nicht:</strong> Möglicherweise ist die Verbindung zum Server unterbrochen. Versuchen Sie es später erneut.</li>
            </ul>
          </div>
        </div>

        <!-- Admin-Oberfläche -->
        <div class="admin-panel" id="adminPanel">
          <h2>Admin-Oberfläche</h2>
          
          <div class="admin-controls">
            <button id="downloadAllBtn" style="background: #795548;">Alles herunterladen</button>
            <button id="refreshAdminBtn" style="background: #009688;">Aktualisieren</button>
          </div>
          
          <p>Hinweis: Klicken Sie auf den "Öffentlich/Privat"-Button, um die Sichtbarkeit einer Datei zu ändern.</p>
          
          <ul id="adminFileList"></ul>
          <button id="closeAdminBtn">Admin schließen</button>
        </div>

        <!-- Admin-Login Button -->
        <button id="adminLoginBtn">Admin Login</button>

        <!-- Password Modal -->
        <div id="passwordModal" class="modal">
          <div class="modal-content">
            <h3 class="modal-title">Admin Login</h3>
            <p>Bitte geben Sie das Admin-Passwort ein:</p>
            <input type="password" id="adminPasswordInput" placeholder="Passwort">
            <div class="modal-footer">
              <button id="cancelLoginBtn" style="background-color: #f44336;">Abbrechen</button>
              <button id="confirmLoginBtn" style="background-color: #4CAF50;">Anmelden</button>
            </div>
          </div>
        </div>

        <!-- JSZip & FileSaver für „Alles herunterladen" -->
        <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
        <!-- Supabase von CDN direkt einbinden -->
        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

        <!-- Regular JavaScript statt ES Module -->
        <script>
          // --- 1) SUPABASE KONFIG --- 
          const SUPABASE_URL = "https://qzmzlrsfuepbkqwzbrir.supabase.co";
          const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6bXpscnNmdWVwYmtxd3picmlyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDE5NTkxMzAsImV4cCI6MjA1NzUzNTEzMH0.zLZDSfylloUxlxYPEpfO4VMAdf0cNpUzKH2T9qv8ezI";
          
          // Admin-Passwörter
          const TEACHER_ADMIN_PASSWORD = "Welt";
          const SUPER_ADMIN_PASSWORD = "Luna";
          
          // Präfix und Suffix für öffentliche Dateien
          const PUBLIC_PREFIX = "public_";
          
          // Initialisiere Supabase Client - nur EINMAL für die gesamte App
          let supabaseClient;
          try {
            // Erstelle den Client mit deaktiviertem Caching und Auth
            const options = {
              db: {
                schema: 'public'
              },
              auth: {
                autoRefreshToken: false,
                persistSession: false,
                detectSessionInUrl: false
              },
              global: {
                headers: {
                  'Cache-Control': 'no-cache',
                  'Pragma': 'no-cache'
                }
              }
            };
            
            // Erstelle den Client nur einmal
            supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, options);
            console.log("Supabase Client erfolgreich initialisiert");
          } catch (err) {
            console.error("Fehler bei der Supabase-Initialisierung:", err);
            showError("Verbindungsfehler: Bitte später erneut versuchen.");
          }
          
          // Funktion zum Aktualisieren der Dateilisten
          function refreshFileList() {
            // Cache leeren
            clearLocalCache();
            
            // Dateilisten neu laden ohne neuen Client zu erstellen
            loadFilesByREST();
            
            // Admin-Dateien neu laden, falls im Admin-Bereich
            if (appSettings.adminLoggedIn) {
              loadAdminFilesByREST();
            }
          }

          // --- 2) Variablen ---
          let mediaRecorder;
          let audioStream;
          let audioChunks = [];
          let currentRecordingBlob = null;
          let audioContext, analyser, dataArray, animationId;
          let recordingTime = 0;
          let recordingInterval = null;
          let isPaused = false;
          let isRecording = false;
          
          // Variable für den Audio-Verstärker (GainNode)
          let gainNode;
          // Standard-Verstärkungsfaktor (1.25x = 25% lauter)
          const GAIN_VALUE = 1.25;
          
          // Eigene Uploads speichern
          let myUploads = [];
          
          // Geräte- und Format-Erkennung
          const appSettings = {
            adminLoggedIn: false,
            adminType: '', // 'teacher' oder 'super'
            lastFileName: localStorage.getItem('lastFileName') || '',
            isIOS: /iPad|iPhone|iPod/.test(navigator.userAgent) || /Mac/.test(navigator.userAgent) && navigator.maxTouchPoints > 0,
            isSafari: /^((?!chrome|android).)*safari/i.test(navigator.userAgent),
            bestAudioFormat: 'audio/mp4', // Standard-Fallback für iOS
            myUploads: JSON.parse(localStorage.getItem('myUploads') || '[]'),
            selectedTeacherCode: localStorage.getItem('selectedTeacherCode') || '',
            selectedTeacherName: localStorage.getItem('selectedTeacherName') || ''
          };
          
          // Lade Uploads aus localStorage
          myUploads = appSettings.myUploads;

          // --- 3) DOM-Elemente ---
          let filenameInput, startBtn, pauseBtn, resumeBtn, stopBtn, uploadBtn, clearStorageBtn;
          let audioPlayer, uploadStatus, fileList, adminPanel, adminFileList, adminLoginBtn;
          let closeAdminBtn, refreshAdminBtn, visualizerCircle, downloadAllBtn, timerDisplay;
          let recordingStatus, formatInfo, currentFormat, tabButtons, tabContents;
          let passwordModal, adminPasswordInput, confirmLoginBtn, cancelLoginBtn;

          // --- Initialisierungsfunktion für die Podcast-App ---
          window.initPodcastApp = function() {
            // DOM-Elemente erst nach dem Laden zuweisen
            filenameInput = document.getElementById("filename");
            startBtn = document.getElementById("startBtn");
            pauseBtn = document.getElementById("pauseBtn");
            resumeBtn = document.getElementById("resumeBtn");
            stopBtn = document.getElementById("stopBtn");
            uploadBtn = document.getElementById("uploadBtn");
            clearStorageBtn = document.getElementById("clearStorageBtn");
            audioPlayer = document.getElementById("audioPlayer");
            uploadStatus = document.getElementById("uploadStatus");
            fileList = document.getElementById("fileList");
            adminPanel = document.getElementById("adminPanel");
            adminFileList = document.getElementById("adminFileList");
            adminLoginBtn = document.getElementById("adminLoginBtn");
            closeAdminBtn = document.getElementById("closeAdminBtn");
            refreshAdminBtn = document.getElementById("refreshAdminBtn");
            visualizerCircle = document.getElementById("visualizerCircle");
            downloadAllBtn = document.getElementById("downloadAllBtn");
            timerDisplay = document.getElementById("timerDisplay");
            recordingStatus = document.getElementById("recordingStatus");
            formatInfo = document.getElementById("formatInfo");
            currentFormat = document.getElementById("currentFormat");
            tabButtons = document.querySelectorAll(".tab-button");
            tabContents = document.querySelectorAll(".tab-content");
            passwordModal = document.getElementById("passwordModal");
            adminPasswordInput = document.getElementById("adminPasswordInput");
            confirmLoginBtn = document.getElementById("confirmLoginBtn");
            cancelLoginBtn = document.getElementById("cancelLoginBtn");
            
            // Initialisiere die App
            init();
          };

          // --- Prüft ob eine Datei öffentlich ist (beginnt mit dem PUBLIC_PREFIX) ---
          function isFilePublic(fileName) {
            return fileName.startsWith(PUBLIC_PREFIX);
          }
          
          // --- Gibt den angezeigten Dateinamen (ohne Präfix) zurück ---
          function getDisplayFileName(fileName) {
            if (isFilePublic(fileName)) {
              return fileName.substring(PUBLIC_PREFIX.length);
            }
            return fileName;
          }
          
          // --- Prüft, ob eine Datei dem aktuellen Lehrer gehört ---
          function isFileForCurrentTeacher(fileName) {
            const teacherCode = appSettings.selectedTeacherCode;
            // Prüfen, ob der Dateiname mit dem Lehrercode beginnt
            // Öffentliche Dateien haben das PUBLIC_PREFIX, daher müssen wir nach dem Prefix suchen
            if (isFilePublic(fileName)) {
              const nameWithoutPrefix = fileName.substring(PUBLIC_PREFIX.length);
              return nameWithoutPrefix.startsWith(teacherCode + "_");
            } else {
              return fileName.startsWith(teacherCode + "_");
            }
          }

          // --- Funktion zum Laden der Dateien über den Supabase-Client ---
          function loadFilesByREST() {
            fileList.innerHTML = "<li>Dateien werden geladen...</li>";
            
            // Supabase Client verwenden
            supabaseClient.storage
              .from('podcast-audio')
              .list('', {
                sortBy: { column: 'name', order: 'asc' }
              })
              .then(response => {
                if (response.error) {
                  throw response.error;
                }
                
                const files = response.data || [];
                
                if (!files || files.length === 0) {
                  fileList.innerHTML = "<li>Keine Aufnahmen vorhanden</li>";
                  return;
                }
                
                fileList.innerHTML = "";
                
                // Zur Anzeige ausgewählte Dateien
                const visibleFiles = files.filter(file => {
                  const userOwnsFile = myUploads.includes(file.name);
                  const isPublic = isFilePublic(file.name);
                  const isForCurrentTeacher = isFileForCurrentTeacher(file.name);
                  
                  // Dateien anzeigen, die dem Benutzer gehören ODER öffentlich sind UND dem aktuellen Lehrer zugeordnet sind
                  return userOwnsFile || (isPublic && isForCurrentTeacher);
                });
                
                if (visibleFiles.length === 0) {
                  fileList.innerHTML = "<li>Keine sichtbaren Aufnahmen vorhanden</li>";
                  return;
                }
                
                // Cache-Busting Parameter
                const cacheBuster = Date.now();
                
                // Liste erstellen
                for (const file of visibleFiles) {
                  // Öffentliche URL generieren
                  const { data } = supabaseClient.storage
                    .from('podcast-audio')
                    .getPublicUrl(file.name);
                    
                  const publicUrl = data.publicUrl;
                  
                  // Cache-Busting Parameter zum URL hinzufügen
                  const noCacheUrl = publicUrl + (publicUrl.includes('?') ? '&' : '?') + '_cb=' + cacheBuster;
                  
                  const isPublic = isFilePublic(file.name);
                  const isOwner = myUploads.includes(file.name);
                  const displayName = getDisplayFileName(file.name);
                  
                  const li = document.createElement('li');
                  if (isPublic) {
                    li.className = 'public-file';
                  }
                  
                  li.innerHTML = `
                    <a href="${noCacheUrl}" target="_blank" download="${file.name}">
                      ${displayName}
                    </a>
                    <span class="file-size">(${formatBytes(file.metadata?.size || 0)})</span>
                    ${isPublic ? '<span class="file-visibility-icon">👁️</span>' : ''}
                    ${isOwner ? ' (Meine Datei)' : ''}
                  `;
                  
                  fileList.appendChild(li);
                }
              })
              .catch(function(err) {
                console.error("Fehler beim Laden der Dateien:", err);
                fileList.innerHTML = "<li class='error-message'>Fehler beim Laden der Dateien: " + (err.message || "Unbekannter Fehler") + "</li>";
              });
          }

          // --- Funktion zum Laden der Admin-Dateien ---
          function loadAdminFilesByREST() {
            adminFileList.innerHTML = "<li>Dateien werden geladen...</li>";
            
            // Supabase Client verwenden
            supabaseClient.storage
              .from('podcast-audio')
              .list('', {
                sortBy: { column: 'name', order: 'asc' }
              })
              .then(response => {
                if (response.error) {
                  throw response.error;
                }
                
                const files = response.data || [];
                
                if (!files || files.length === 0) {
                  adminFileList.innerHTML = "<li>Keine Aufnahmen vorhanden</li>";
                  return;
                }
                
                // Filtere Dateien für Lehrer-Admin, Super-Admin sieht alle
                let adminFiles = files;
                if (appSettings.adminType === 'teacher') {
                  adminFiles = files.filter(file => isFileForCurrentTeacher(file.name));
                  if (adminFiles.length === 0) {
                    adminFileList.innerHTML = "<li>Keine Aufnahmen für diesen Lehrer vorhanden</li>";
                    return;
                  }
                }
                
                adminFileList.innerHTML = "";
                
                // Cache-Busting Parameter
                const cacheBuster = Date.now();
                
                // Admin-Liste erstellen
                for (const file of adminFiles) {
                  // Öffentliche URL generieren
                  const { data } = supabaseClient.storage
                    .from('podcast-audio')
                    .getPublicUrl(file.name);
                    
                  const publicUrl = data.publicUrl;
                  
                  // Cache-Busting Parameter zum URL hinzufügen
                  const noCacheUrl = publicUrl + (publicUrl.includes('?') ? '&' : '?') + '_cb=' + cacheBuster;
                  
                  const isPublic = isFilePublic(file.name);
                  const displayName = getDisplayFileName(file.name);
                  
                  const li = document.createElement('li');
                  li.className = isPublic ? 'public-file' : 'private-file';
                  li.dataset.filename = file.name;
                  
                  li.innerHTML = `
                    <a href="${noCacheUrl}" target="_blank">${displayName}</a>
                    <span class="file-size">(${formatBytes(file.metadata?.size || 0)})</span>
                    <span class="file-visibility">
                      <span class="file-visibility-icon">${isPublic ? '👁️' : '🔒'}</span>
                    </span>
                    <button class="toggle-visibility" data-filename="${file.name}">
                      ${isPublic ? 'Privat machen' : 'Öffentlich machen'}
                    </button>
                    <button class="delete" data-filename="${file.name}">Löschen</button>
                  `;
                  
                  adminFileList.appendChild(li);
                }
              })
              .catch(function(err) {
                console.error("Fehler beim Laden der Admin-Dateien:", err);
                adminFileList.innerHTML = "<li class='error-message'>Fehler beim Laden der Dateien: " + (err.message || "Unbekannter Fehler") + "</li>";
              });
          }

          // --- 4) Initialisierung ---
          function init() {
            // Debug-Info für bessere Fehlerbehebung
            console.log("Browser-Info:", navigator.userAgent);
            console.log("Geräteerkennung - iOS:", appSettings.isIOS, "Safari:", appSettings.isSafari);
            console.log("Ausgewählter Lehrer:", appSettings.selectedTeacherName, "Code:", appSettings.selectedTeacherCode);
            
            // Cache löschen beim Start
            clearLocalCache();
            
            // Lokalen Aufnahmespeicher löschen - für Datenschutz bei jedem Neuladen
            clearSavedRecording();
            
            // Default-Dateiname mit Lehrerkürzel vorbelegen
            if (appSettings.selectedTeacherCode) {
              const defaultName = appSettings.selectedTeacherCode + "_";
              filenameInput.placeholder = "Schülername eingeben";
              if (!filenameInput.value) {
                filenameInput.value = defaultName;
              }
            }
            
            // Lade gespeicherte Einstellungen aus dem LocalStorage
            if (appSettings.lastFileName) {
              filenameInput.value = appSettings.lastFileName;
            }
            
            // Immer validateFileName ausführen, um den Button-Status zu aktualisieren
            validateFileName();
            
            // Prüfe Browser-Unterstützung
            if (!checkBrowserSupport()) return;
            
            // Bestimme das beste Audio-Format für diesen Browser
            determineOptimalAudioFormat();
            
            // Setze Event Listeners
            setupEventListeners();
            
            // Prüfe, ob es eine gespeicherte Aufnahme gibt
            checkForSavedRecording();
            
            // Lade vorhandene Dateien mit direkter REST-API
            loadFilesByREST();
          }

          // --- Function: Cache löschen ---
          function clearLocalCache() {
            console.log("Lokalen Cache für Dateien löschen...");
            
            // Entferne Dateilisten-Cache
            sessionStorage.removeItem('fileListCache');
            
            // Entferne gespeicherte API-Antworten
            for (let i = 0; i < sessionStorage.length; i++) {
              const key = sessionStorage.key(i);
              if (key && key.startsWith('api_')) {
                sessionStorage.removeItem(key);
              }
            }
            
            console.log("Lokaler Cache gelöscht");
          }

          // --- 5) Browser-Unterstützung prüfen ---
          function checkBrowserSupport() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
              showError("Ihr Browser unterstützt keine Audioaufnahmen. Bitte verwenden Sie einen modernen Browser wie Chrome, Firefox oder Edge.");
              startBtn.disabled = true;
              return false;
            }
            return true;
          }
          
          // --- Datei-Sichtbarkeit ändern (durch Umbenennen) ---
          async function setFilePublic(fileName, isPublic) {
            try {
              // Check current status
              const currentlyPublic = isFilePublic(fileName);
              
              // Already in desired state
              if (currentlyPublic === isPublic) {
                console.log(`Datei ${fileName} ist bereits ${isPublic ? 'öffentlich' : 'privat'}`);
                return true;
              }
              
              // Determine new filename
              let newFileName;
              if (isPublic && !currentlyPublic) {
                // Make public: Add prefix
                newFileName = PUBLIC_PREFIX + fileName;
              } else if (!isPublic && currentlyPublic) {
                // Make private: Remove prefix
                newFileName = fileName.substring(PUBLIC_PREFIX.length);
              } else {
                // No change needed (should not happen)
                return true;
              }
              
              console.log(`Ändere Datei von ${fileName} zu ${newFileName}`);
              
              // Download current file
              const { data: fileData, error: fileError } = await supabaseClient.storage
                .from('podcast-audio')
                .download(fileName);
              
              if (fileError) {
                console.error("Fehler beim Herunterladen der Datei:", fileError);
                throw fileError;
              }
              
              // Upload with new name
              const { error: uploadError } = await supabaseClient.storage
                .from('podcast-audio')
                .upload(newFileName, fileData, {
                  contentType: 'audio/mp4',
                  upsert: true
                });
              
              if (uploadError) {
                console.error("Fehler beim Hochladen mit neuem Namen:", uploadError);
                throw uploadError;
              }
              
              // Delete old file
              const { error: deleteError } = await supabaseClient.storage
                .from('podcast-audio')
                .remove([fileName]);
              
              if (deleteError) {
                console.error("Fehler beim Löschen der alten Datei:", deleteError);
                throw deleteError;
              }
              
              // Update myUploads list
              if (myUploads.includes(fileName)) {
                myUploads = myUploads.filter(name => name !== fileName);
                myUploads.push(newFileName);
                localStorage.setItem('myUploads', JSON.stringify(myUploads));
                appSettings.myUploads = myUploads;
              }
              
              console.log(`Datei erfolgreich ${isPublic ? 'öffentlich' : 'privat'} gemacht:`, newFileName);
              return true;
            } catch (error) {
              console.error("Fehler beim Ändern der Sichtbarkeit:", error);
              showError("Fehler beim Ändern der Sichtbarkeit: " + (error.message || "Unbekannter Fehler"));
              return false;
            }
          }
          
          // --- Beste Audio-Format-Erkennung ---
          function determineOptimalAudioFormat() {
            // Für iOS-Geräte werden wir diese Formate in dieser Reihenfolge testen
            const formatsToTest = [
              'audio/mp4',
              'audio/aac',
              'audio/wav',
              'audio/mpeg',
              'audio/webm;codecs=pcm',
              'audio/webm'
            ];
            
            let foundFormat = false;
            
            // Standardwert anzeigen während wir testen
            currentFormat.textContent = "Wird geprüft...";
            
            for (const format of formatsToTest) {
              if (MediaRecorder.isTypeSupported(format)) {
                console.log(`Format ${format} wird unterstützt!`);
                appSettings.bestAudioFormat = format;
                currentFormat.textContent = formatReadableName(format);
                foundFormat = true;
                break;
              } else {
                console.log(`Format ${format} wird nicht unterstützt.`);
              }
            }
            
            if (!foundFormat) {
              // Wenn kein getestetes Format unterstützt wird, verwenden wir den Standard-MediaRecorder ohne expliziten mimeType
              currentFormat.textContent = "Standard (geräteabhängig)";
              console.warn("Kein bekanntes Format wird unterstützt. Verwende Standard-Format des Browsers.");
              appSettings.bestAudioFormat = '';
            }
          }
          
          function formatReadableName(mimeType) {
            const formatMap = {
              'audio/mp4': 'MP4 Audio',
              'audio/aac': 'AAC Audio',
              'audio/wav': 'WAV Audio',
              'audio/mpeg': 'MP3 Audio',
              'audio/webm': 'WebM Audio',
              'audio/webm;codecs=pcm': 'WebM PCM Audio'
            };
            
            return formatMap[mimeType] || mimeType;
          }
          
          function getFileExtension(mimeType) {
            const extensionMap = {
              'audio/mp4': '.m4a',
              'audio/aac': '.aac',
              'audio/wav': '.wav',
              'audio/mpeg': '.mp3',
              'audio/webm': '.webm',
              'audio/webm;codecs=pcm': '.webm'
            };
            
            return extensionMap[mimeType] || '.m4a'; // Standardmäßig .m4a für iOS
          }

          // --- 6) Event Listeners ---
          function setupEventListeners() {
            // Dateiname-Validierung
            filenameInput.addEventListener("input", validateFileName);
            
            // Aufnahme-Steuerung
            startBtn.addEventListener("click", startRecording);
            pauseBtn.addEventListener("click", pauseRecording);
            resumeBtn.addEventListener("click", resumeRecording);
            stopBtn.addEventListener("click", stopRecording);
            uploadBtn.addEventListener("click", uploadRecording);
            clearStorageBtn.addEventListener("click", clearAllLocalStorage);
            
            // Admin-Bereich
            adminLoginBtn.addEventListener("click", showPasswordModal);
            closeAdminBtn.addEventListener("click", () => {
              adminPanel.style.display = "none";
              appSettings.adminLoggedIn = false;
              appSettings.adminType = '';
            });
            downloadAllBtn.addEventListener("click", downloadAllFiles);
            refreshAdminBtn.addEventListener("click", loadAdminFilesByREST);
            
            // Password Modal
            confirmLoginBtn.addEventListener("click", handleAdminLogin);
            cancelLoginBtn.addEventListener("click", hidePasswordModal);
            adminPasswordInput.addEventListener("keyup", (e) => {
              if (e.key === "Enter") {
                handleAdminLogin();
              }
            });
            
            // Tab-Navigation
            tabButtons.forEach(button => {
              button.addEventListener("click", () => {
                const tabId = button.dataset.tab;
                
                // Aktiven Tab wechseln
                tabButtons.forEach(btn => btn.classList.remove("active"));
                tabContents.forEach(content => content.classList.remove("active"));
                
                button.classList.add("active");
                document.getElementById(`${tabId}-tab`).classList.add("active");
              });
            });

            // Dateiliste Verwalten (für Admin)
            adminFileList.addEventListener("click", handleAdminFileAction);
            
            // Für iOS Touch-Events aktivieren
            if (appSettings.isIOS) {
              document.addEventListener('touchstart', function(){}, {passive: true});
            }
          }

          // --- 7) Dateiname-Validierung ---
          function validateFileName() {
            const filename = filenameInput.value.trim();
            const teacherCode = appSettings.selectedTeacherCode;
            
            // Prüfe, ob der Dateiname mit dem Lehrercode beginnt
            if (filename && teacherCode) {
              if (!filename.startsWith(teacherCode + "_")) {
                // Wenn der Dateiname nicht mit dem Code beginnt, füge ihn hinzu
                filenameInput.value = teacherCode + "_" + filename;
                localStorage.setItem('lastFileName', filenameInput.value);
              }
              
              startBtn.disabled = false;
            } else if (filename) {
              startBtn.disabled = false;
              localStorage.setItem('lastFileName', filename);
            } else {
              startBtn.disabled = true;
            }

            // Debug-Information
            console.log("Dateiname validiert:", filenameInput.value, "Start-Button aktiviert:", !startBtn.disabled);
          }
          
          // --- 7.1) Admin-Login-Funktion ---
          function handleAdminLogin() {
            const enteredPassword = adminPasswordInput.value;
            
            // Prüfe Lehrer-Admin
            if (enteredPassword === TEACHER_ADMIN_PASSWORD) {
              // Lehrer-Admin kann nur eigene Dateien sehen
              appSettings.adminLoggedIn = true;
              appSettings.adminType = 'teacher';
              hidePasswordModal();
              adminPanel.style.display = 'block';
              
              // Admin-Dateien laden (nur für diesen Lehrer)
              loadAdminFilesByREST();
              
              showSuccess(`Admin-Bereich für ${appSettings.selectedTeacherName} freigeschaltet.`);
            }
            // Prüfe Super-Admin
            else if (enteredPassword === SUPER_ADMIN_PASSWORD) {
              // Super-Admin sieht alle Dateien
              appSettings.adminLoggedIn = true;
              appSettings.adminType = 'super';
              hidePasswordModal();
              adminPanel.style.display = 'block';
              
              // Admin-Dateien laden (alle)
              loadAdminFilesByREST();
              
              showSuccess("Super-Admin-Bereich freigeschaltet.");
            }
            else {
              // Falsches Passwort
              showError("Falsches Passwort!");
              adminPasswordInput.value = "";
              adminPasswordInput.focus();
            }
          }
          
          // --- 7.2) Zeige Password Modal ---
          function showPasswordModal() {
            passwordModal.style.display = "block";
            adminPasswordInput.value = "";
            adminPasswordInput.focus();
          }
          
          // --- 7.3) Verstecke Password Modal ---
          function hidePasswordModal() {
            passwordModal.style.display = "none";
          }
          
          // --- 7.4) Lokalen Speicher vollständig löschen ---
          function clearAllLocalStorage() {
            if (confirm("Möchten Sie wirklich den gesamten lokalen Speicher löschen? Dies entfernt alle gespeicherten Aufnahmen und Einstellungen.")) {
              // Speicher für aktuelle Aufnahme löschen
              clearSavedRecording();
              
              // Benutzereinstellungen löschen
              localStorage.removeItem('lastFileName');
              localStorage.removeItem('myUploads');
              
              // Session Storage leeren
              sessionStorage.clear();
              
              // Audio-Player zurücksetzen
              audioPlayer.src = '';
              
              // Variable zurücksetzen
              currentRecordingBlob = null;
              myUploads = [];
              appSettings.myUploads = [];
              
              // UI aktualisieren
              uploadBtn.disabled = true;
              
              // Dateiliste aktualisieren
              loadFilesByREST();
              
              showSuccess("Lokaler Speicher wurde vollständig gelöscht.");
            }
          }

          // --- 8) Aufnahme starten ---
          function startRecording() {
            // Dateiname aus Input holen und sicherstellen, dass der Lehrer-Code enthalten ist
            let filename = filenameInput.value.trim();
            const teacherCode = appSettings.selectedTeacherCode;
            
            if (!filename) {
              showError("Bitte erst einen Schülernamen eingeben!");
              return;
            }
            
            // Sicherstellen, dass der Dateiname das korrekte Format hat
            if (teacherCode && !filename.startsWith(teacherCode + "_")) {
              filename = teacherCode + "_" + filename;
              filenameInput.value = filename;
            }
            
            if (!checkBrowserSupport()) return;
            
            // Spezielle Constraints für iOS
            const constraints = {
              audio: true
            };
            
            if (appSettings.isIOS) {
              // iOS benötigt manchmal explizite Einstellungen
              constraints.audio = {
                echoCancellation: false,
                noiseSuppression: false,
                autoGainControl: false
              };
            }
            
            // Audiostream anfordern
            navigator.mediaDevices.getUserMedia(constraints)
              .then(function(stream) {
                audioStream = stream;
                
                audioContext = new AudioContext();
                const source = audioContext.createMediaStreamSource(stream);
                
                // GainNode für die Verstärkung erstellen
                gainNode = audioContext.createGain();
                gainNode.gain.value = GAIN_VALUE; // Verstärkung um Faktor 1.25
                
                // Verbindung herstellen: Quelle -> Verstärker
                source.connect(gainNode);
                
                // Destination für MediaRecorder
                const destination = audioContext.createMediaStreamDestination();
                gainNode.connect(destination);
                
                // WICHTIG: Der verstärkte Stream für den MediaRecorder
                const amplifiedStream = destination.stream;
                
                // MediaRecorder initialisieren
                let recorderOptions = {};
                
                // Verwende das beste erkannte Format, wenn verfügbar
                if (appSettings.bestAudioFormat) {
                  recorderOptions.mimeType = appSettings.bestAudioFormat;
                  console.log(`Verwende Format: ${appSettings.bestAudioFormat}`);
                } else {
                  console.log("Verwende Standard-Format des Browsers");
                }
                
                try {
                  // Verstärkten Stream für die Aufnahme verwenden
                  mediaRecorder = new MediaRecorder(amplifiedStream, recorderOptions);
                } catch (formatError) {
                  console.error("Format wird nicht unterstützt:", formatError);
                  console.log("Versuche ohne mimeType-Angabe...");
                  mediaRecorder = new MediaRecorder(amplifiedStream);
                  
                  // Update formatInfo-Anzeige
                  currentFormat.textContent = "Standard (geräteabhängig)";
                }
                
                // MediaRecorder-Format anzeigen
                if (mediaRecorder.mimeType) {
                  currentFormat.textContent = formatReadableName(mediaRecorder.mimeType);
                  console.log("Tatsächlich verwendetes Format:", mediaRecorder.mimeType);
                  appSettings.bestAudioFormat = mediaRecorder.mimeType;
                }
                
                audioChunks = [];
                
                // Event Handling
                mediaRecorder.ondataavailable = handleDataAvailable;
                mediaRecorder.onstop = handleRecordingStop;
                mediaRecorder.onpause = handleRecordingPause;
                mediaRecorder.onresume = handleRecordingResume;
                mediaRecorder.onerror = function(event) {
                  showError("Aufnahmefehler: " + event.error);
                };
                
                // Aufnahme starten
                mediaRecorder.start(100); // Chunks alle 100ms für bessere iOS-Kompatibilität
                isRecording = true;
                isPaused = false;
                
                // UI aktualisieren
                updateRecordingUI(true);
                
                // Für den Visualizer den ursprünglichen Stream verwenden (ohne Verstärkung)
                startVisualizer(stream);
                startTimer();
                
                showMessage("Aufnahme läuft...", true);
              })
              .catch(function(err) {
                let errorMsg = "Aufnahmefehler";
                
                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                  errorMsg = "Mikrofon-Zugriff verweigert. Bitte erteilen Sie die Berechtigung in Ihren Browsereinstellungen.";
                } else if (err.name === 'NotFoundError') {
                  errorMsg = "Kein Mikrofon gefunden. Bitte prüfen Sie, ob ein Mikrofon angeschlossen ist.";
                } else {
                  errorMsg = err.message || "Aufnahmefehler. Bitte versuchen Sie es erneut.";
                }
                
                showError(errorMsg);
                console.error("Aufnahmefehler:", err);
              });
          }
          
          // --- 9) Aufnahme pausieren ---
          function pauseRecording() {
            if (mediaRecorder && mediaRecorder.state === "recording") {
              try {
                mediaRecorder.pause();
                isPaused = true;
                pauseTimer();
                pauseVisualizer();
                updateRecordingUI(true, true);
                showMessage("Aufnahme pausiert", false);
              } catch (error) {
                console.error("Fehler beim Pausieren:", error);
                // Wenn pausieren auf iOS fehlschlägt, bieten wir an, stattdessen zu stoppen
                if (appSettings.isIOS) {
                  showWarning("Pausieren wird auf einigen iOS-Geräten nicht unterstützt. Bitte stoppen Sie die Aufnahme, wenn Sie fertig sind.");
                }
              }
            }
          }
          
          // --- 10) Aufnahme fortsetzen ---
          function resumeRecording() {
            if (mediaRecorder && mediaRecorder.state === "paused") {
              try {
                mediaRecorder.resume();
                isPaused = false;
                resumeTimer();
                resumeVisualizer();
                updateRecordingUI(true, false);
                showMessage("Aufnahme fortgesetzt", true);
              } catch (error) {
                console.error("Fehler beim Fortsetzen:", error);
                showWarning("Es gab ein Problem beim Fortsetzen der Aufnahme. Versuchen Sie, die Aufnahme zu stoppen und neu zu starten.");
              }
            }
          }

          // --- 11) Aufnahme stoppen ---
          function stopRecording() {
            if (mediaRecorder && (mediaRecorder.state === "recording" || mediaRecorder.state === "paused")) {
              try {
                mediaRecorder.stop();
                isRecording = false;
                isPaused = false;
                
                if (audioStream) {
                  audioStream.getTracks().forEach(function(track) {
                    track.stop();
                  });
                }
                
                stopTimer();
                stopVisualizer();
                updateRecordingUI(false);
                
                // AudioContext und GainNode schließen
                if (audioContext) {
                  audioContext.close().catch(err => console.warn("Fehler beim Schließen des AudioContext:", err));
                }
              } catch (error) {
                console.error("Fehler beim Stoppen der Aufnahme:", error);
                showError("Fehler beim Stoppen der Aufnahme. Bitte laden Sie die Seite neu.");
                
                // Notfall-Reset falls das Stoppen nicht funktioniert
                isRecording = false;
                isPaused = false;
                stopTimer();
                stopVisualizer();
                updateRecordingUI(false);
                
                if (audioStream) {
                  audioStream.getTracks().forEach(function(track) {
                    track.stop();
                  });
                }
                
                // AudioContext und GainNode schließen im Fehlerfall
                if (audioContext) {
                  audioContext.close().catch(err => console.warn("Fehler beim Schließen des AudioContext:", err));
                }
              }
            }
          }

          // --- 12) Media Recorder Event Handler ---
          function handleDataAvailable(event) {
            if (event.data && event.data.size > 0) {
              audioChunks.push(event.data);
              // Speichere den aktuellen Stand im LocalStorage
              saveRecordingChunks();
            }
          }
          
          function handleRecordingStop() {
            try {
              // Erstelle Blob aus gesammelten Daten
              const mimeType = appSettings.bestAudioFormat || 'audio/mp4';
              currentRecordingBlob = new Blob(audioChunks, { type: mimeType });
              
              // Audio-Player aktualisieren
              const audioUrl = URL.createObjectURL(currentRecordingBlob);
              audioPlayer.src = audioUrl;
              
              // UI aktualisieren
              uploadBtn.disabled = false;
              showMessage("Aufnahme bereit – bitte jetzt anhören und hochladen.", false);
              
              // Lokale Kopie speichern
              saveRecording(currentRecordingBlob, mimeType);
              
              console.log("Aufnahme erfolgreich gestoppt. Größe:", formatBytes(currentRecordingBlob.size), "Format:", mimeType);
            } catch (error) {
              console.error("Fehler beim Verarbeiten der Aufnahme:", error);
              showError("Fehler beim Verarbeiten der Aufnahme: " + error.message);
            }
          }
          
          function handleRecordingPause() {
            showMessage("Aufnahme pausiert", false);
          }
          
          function handleRecordingResume() {
            showMessage("Aufnahme fortgesetzt", true);
          }

          // --- 13) Aufnahme hochladen ---
          function uploadRecording() {
            if (!currentRecordingBlob) {
              showError("Keine Aufnahme vorhanden!");
              return;
            }
            
            showMessage("Wird hochgeladen...", false);
            uploadBtn.disabled = true;
            
            // Dateinamen vorbereiten und sicherstellen, dass er mit dem Lehrerkürzel beginnt
            let baseName = filenameInput.value.trim();
            const teacherCode = appSettings.selectedTeacherCode;
            
            // Sicherstellen, dass der Dateiname mit dem Lehrerkürzel beginnt
            if (teacherCode && !baseName.startsWith(teacherCode + "_")) {
              baseName = teacherCode + "_" + baseName;
            }
            
            const mimeType = appSettings.bestAudioFormat || 'audio/mp4';
            let extension = getFileExtension(mimeType);
            
            // Aktuelles Datum für den Dateinamen
            const today = new Date();
            const dateString = today.getFullYear() + 
                              ('0' + (today.getMonth() + 1)).slice(-2) + 
                              ('0' + today.getDate()).slice(-2);
            
            // Uhrzeit für Eindeutigkeit bei Namensgleichheit
            const timeString = ('0' + today.getHours()).slice(-2) + 
                              ('0' + today.getMinutes()).slice(-2);
            
            // Eindeutigen Dateinamen erstellen
            let fileName = `${baseName}_${dateString}_${timeString}${extension}`;
            
            console.log("Upload starten: Datei", fileName, "Größe:", formatBytes(currentRecordingBlob.size), "Format:", mimeType);
            
            // Supabase Storage Upload mit ContentType
            supabaseClient.storage
              .from('podcast-audio')
              .upload(fileName, currentRecordingBlob, { 
                contentType: mimeType,
                upsert: true, // Überschreiben falls Datei existiert
                cacheControl: '0' // Vermeidet Caching
              })
              .then(function(response) {
                if (response.error) {
                  throw response.error;
                }
                
                // Speichere in myUploads, dass diese Datei vom Benutzer hochgeladen wurde
                if (!myUploads.includes(fileName)) {
                  myUploads.push(fileName);
                  localStorage.setItem('myUploads', JSON.stringify(myUploads));
                  appSettings.myUploads = myUploads;
                }
                
                // Erfolgsmeldung
                showSuccess("✅ Erfolgreich hochgeladen: " + fileName);
                currentRecordingBlob = null;
                
                // Lokale Aufnahme löschen
                clearSavedRecording();
                
                // Dateiliste aktualisieren
                refreshFileList();
              })
              .catch(function(error) {
                console.error("Upload-Fehler:", error);
                showError("❌ Fehler beim Upload: " + (error.message || "Verbindungsproblem"));
                uploadBtn.disabled = false;
              });
          }

          // --- 14) Admin-Dateiaktionen mit echtem Löschen und Sichtbarkeitsänderung ---
          function handleAdminFileAction(e) {
            const target = e.target;
            
            // Datei löschen
            if (target.classList.contains("delete")) {
              const fileName = target.getAttribute("data-filename");
              
              if (!confirm(`Sind Sie sicher, dass Sie die Datei "${getDisplayFileName(fileName)}" löschen möchten?`)) {
                return;
              }
              
              // Anzeigen, dass die Löschung läuft
              target.textContent = "Wird gelöscht...";
              target.disabled = true;
              
              // ECHTES LÖSCHEN mit Supabase Client
              console.log("Beginne echte Löschung für Datei:", fileName);
              
              supabaseClient.storage
                .from('podcast-audio')
                .remove([fileName])
                .then(function(response) {
                  console.log("Löschvorgang Antwort:", response);
                  
                  if (response.error) {
                    throw response.error;
                  }
                  
                  // Entferne aus myUploads
                  if (myUploads.includes(fileName)) {
                    myUploads = myUploads.filter(name => name !== fileName);
                    localStorage.setItem('myUploads', JSON.stringify(myUploads));
                    appSettings.myUploads = myUploads;
                  }
                  
                  // Entferne das Element direkt aus der DOM
                  const liElement = adminFileList.querySelector(`li[data-filename="${fileName}"]`);
                  if (liElement) {
                    liElement.remove();
                  }
                  
                  showSuccess(`Datei '${getDisplayFileName(fileName)}' wurde erfolgreich gelöscht.`);
                  
                  // Die Dateilisten nach kurzer Verzögerung aktualisieren
                  setTimeout(function() {
                    loadFilesByREST();
                    loadAdminFilesByREST();
                  }, 1000);
                })
                .catch(function(err) {
                  console.error("Fehler beim Löschen:", err);
                  showError(`Fehler beim Löschen: ${err.message || "Unbekannter Fehler"}`);
                  target.textContent = "Löschen";
                  target.disabled = false;
                });
            }
            
            // Sichtbarkeit ändern
            if (target.classList.contains("toggle-visibility")) {
              const fileName = target.getAttribute("data-filename");
              const makePublic = target.textContent.includes("Öffentlich machen");
              
              // Button-Status aktualisieren
              target.textContent = "Wird aktualisiert...";
              target.disabled = true;
              
              // Globale Sichtbarkeit durch Umbenennen aktualisieren
              setFilePublic(fileName, makePublic)
                .then(success => {
                  if (success) {
                    showSuccess(`Die Sichtbarkeit von '${getDisplayFileName(fileName)}' wurde aktualisiert.`);
                    
                    // Dateilisten aktualisieren
                    setTimeout(() => {
                      loadFilesByREST();
                      loadAdminFilesByREST();
                    }, 500);
                  } else {
                    // Fehlerfall
                    target.textContent = makePublic ? 'Öffentlich machen' : 'Privat machen';
                    target.disabled = false;
                  }
                });
            }
          }
          
          // --- 15) Alles herunterladen (ZIP) ---
          function downloadAllFiles() {
            showMessage("ZIP-Datei wird vorbereitet...", false);
            
            // Mehr Debugging und robuste Fehlerbehandlung
            console.log("Starte Download aller Dateien...");
            
            // Filter für Admin-Typ
            let fileFilter = null;
            if (appSettings.adminType === 'teacher') {
              // Lehrer-Admin filtert nur seine eigenen Dateien
              fileFilter = (file) => isFileForCurrentTeacher(file.name);
            }
            
            supabaseClient.storage
              .from('podcast-audio')
              .list('', { 
                limit: 100, 
                sortBy: { column: 'name', order: 'asc' }
              })
              .then(function(response) {
                if (response.error) {
                  throw response.error;
                }
                
                let data = response.data || [];
                
                // Filtere Dateien falls nötig
                if (fileFilter) {
                  data = data.filter(fileFilter);
                }
                
                console.log(`${data.length} Dateien gefunden zum Herunterladen.`);
                
                if (!data || data.length === 0) {
                  showWarning("Keine Dateien zum Herunterladen vorhanden.");
                  return;
                }
                
                // ZIP-Datei erstellen
                const zip = new JSZip();
                let completedDownloads = 0;
                let failedDownloads = 0;
                
                // Fortschritt anzeigen
                showMessage(`Lade 0/${data.length} Dateien...`, false);
                
                // Alle Dateien herunterladen und zum ZIP hinzufügen mit verbesserter Fehlerbehandlung
                const downloadPromises = data.map(function(file) {
                  return new Promise(function(resolve) {
                    const fileName = file.name;
                    console.log(`Beginne Download für Datei: ${fileName}`);
                    
                    const { data: urlData } = supabaseClient
                      .storage
                      .from('podcast-audio')
                      .getPublicUrl(fileName);
                    
                    if (!urlData || !urlData.publicUrl) {
                      console.error(`Konnte keine URL für ${fileName} erhalten`);
                      failedDownloads++;
                      resolve();
                      return;
                    }
                    
                    const fileUrl = urlData.publicUrl;
                    console.log(`URL für ${fileName}: ${fileUrl}`);
                    
                    // Versuche 3x mit zunehmender Verzögerung
                    let attempts = 0;
                    const maxAttempts = 3;
                    
                    function attemptDownload() {
                      // Cache-Buster hinzufügen
                      const cacheBustedUrl = fileUrl + (fileUrl.includes('?') ? '&' : '?') + 'cb=' + Date.now();
                      
                      console.log(`Versuch ${attempts+1}/${maxAttempts} für ${fileName}`);
                      
                      fetch(cacheBustedUrl)
                        .then(function(response) {
                          if (!response.ok) {
                            throw new Error(`HTTP Fehler: ${response.status}`);
                          }
                          return response.blob();
                        })
                        .then(function(blob) {
                          // Verwende den angezeigten Namen ohne Präfix im ZIP
                          const displayName = getDisplayFileName(fileName);
                          zip.file(displayName, blob);
                          completedDownloads++;
                          console.log(`Datei ${fileName} erfolgreich heruntergeladen (${completedDownloads}/${data.length})`);
                          showMessage(`Lade ${completedDownloads}/${data.length} Dateien...`, false);
                          resolve();
                        })
                        .catch(function(fetchError) {
                          console.error(`Fetch Fehler für ${fileName} (Versuch ${attempts+1}):`, fetchError);
                          
                          attempts++;
                          if (attempts < maxAttempts) {
                            const delay = attempts * 1000; // Zunehmende Verzögerung (1s, 2s, 3s)
                            console.log(`Neuer Versuch für ${fileName} in ${delay}ms...`);
                            setTimeout(attemptDownload, delay);
                          } else {
                            console.error(`Alle Versuche für ${fileName} fehlgeschlagen.`);
                            failedDownloads++;
                            resolve(); // Trotzdem auflösen, damit andere Dateien verarbeitet werden können
                          }
                        });
                    }
                    
                    attemptDownload();
                  });
                });
                
                // Warten bis alle Downloads abgeschlossen sind
                Promise.all(downloadPromises)
                  .then(function() {
                    // ZIP erstellen und herunterladen
                    console.log(`Alle Downloads abgeschlossen. Erstelle ZIP-Datei mit ${completedDownloads} Dateien.`);
                    showMessage("ZIP-Datei wird erstellt...", false);
                    return zip.generateAsync({ type: "blob" });
                  })
                  .then(function(content) {
                    // Aktuelles Datum für Dateinamen
                    const date = new Date();
                    const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                    
                    // Lehrer-Code in Dateinamen einfügen für Lehrer-Admin
                    let zipFileName = `podcast-aufnahmen-${dateStr}.zip`;
                    if (appSettings.adminType === 'teacher' && appSettings.selectedTeacherCode) {
                      zipFileName = `podcast-aufnahmen-${appSettings.selectedTeacherCode}-${dateStr}.zip`;
                    }
                    
                    console.log(`ZIP-Datei erstellt. Größe: ${formatBytes(content.size)}. Name: ${zipFileName}`);
                    
                    try {
                      saveAs(content, zipFileName);
                      console.log("ZIP-Datei-Download gestartet.");
                      
                      if (failedDownloads > 0) {
                        showWarning(`ZIP-Datei erstellt mit ${completedDownloads} Dateien. ${failedDownloads} Dateien konnten nicht geladen werden.`);
                      } else {
                        showSuccess("ZIP-Datei wurde erstellt und heruntergeladen.");
                      }
                    } catch (saveError) {
                      console.error("Fehler beim Speichern der ZIP-Datei:", saveError);
                      showError("Fehler beim Speichern der ZIP-Datei: " + saveError.message);
                    }
                  })
                  .catch(function(zipError) {
                    console.error("Fehler beim Erstellen der ZIP-Datei:", zipError);
                    showError("Fehler beim ZIP-Erstellen: " + zipError.message);
                  });
              })
              .catch(function(err) {
                console.error("Fehler beim Auflisten der Dateien:", err);
                showError("Fehler beim ZIP-Erstellen: " + err.message);
              });
          }

          // --- 16) Visualizer Funktionen ---
          function startVisualizer(stream) {
            try {
              // Wenn audioContext bereits über startRecording initialisiert wurde, erstelle keinen neuen
              if (!audioContext) {
                audioContext = new AudioContext();
              }
              
              const source = audioContext.createMediaStreamSource(stream);
              analyser = audioContext.createAnalyser();
              analyser.fftSize = 1024;
              source.connect(analyser);
              dataArray = new Uint8Array(analyser.frequencyBinCount);
              
              // Visualizer starten
              animateVisualizer();
            } catch (error) {
              console.warn("Visualizer konnte nicht initialisiert werden:", error);
              // Wir brechen die Aufnahme nicht ab, nur weil der Visualizer nicht funktioniert
            }
          }
          
          function animateVisualizer() {
            if (!analyser) return;
            
            try {
              animationId = requestAnimationFrame(animateVisualizer);
              analyser.getByteTimeDomainData(dataArray);
              
              // RMS (Root Mean Square) Berechnung für Lautstärke
              let sum = 0;
              for (let i = 0; i < dataArray.length; i++) {
                const val = dataArray[i] - 128;
                sum += val * val;
              }
              
              const rms = Math.sqrt(sum / dataArray.length);
              const size = 40 + rms; // Basisgröße + Lautstärke
              
              // Kreisgröße aktualisieren
              visualizerCircle.style.width = size + "px";
              visualizerCircle.style.height = size + "px";
            } catch (error) {
              console.warn("Visualizer-Fehler:", error);
              cancelAnimationFrame(animationId);
            }
          }
          
          function pauseVisualizer() {
            if (animationId) {
              cancelAnimationFrame(animationId);
              animationId = null;
            }
          }
          
          function resumeVisualizer() {
            if (audioContext && analyser) {
              animateVisualizer();
            }
          }
          
          function stopVisualizer() {
            if (animationId) {
              cancelAnimationFrame(animationId);
              animationId = null;
            }
            
            // Audiocontext wird nun im stopRecording geschlossen
            
            // Kreisgröße zurücksetzen
            visualizerCircle.style.width = "40px";
            visualizerCircle.style.height = "40px";
          }

          // --- 17) Timer Funktionen ---
          function startTimer() {
            recordingTime = 0;
            updateTimerDisplay(0);
            recordingInterval = setInterval(function() {
              recordingTime++;
              updateTimerDisplay(recordingTime);
            }, 1000);
          }
          
          function pauseTimer() {
            if (recordingInterval) {
              clearInterval(recordingInterval);
              recordingInterval = null;
            }
          }
          
          function resumeTimer() {
            if (!recordingInterval) {
              recordingInterval = setInterval(function() {
                recordingTime++;
                updateTimerDisplay(recordingTime);
              }, 1000);
            }
          }
          
          function stopTimer() {
            if (recordingInterval) {
              clearInterval(recordingInterval);
              recordingInterval = null;
            }
          }
          
          function updateTimerDisplay(seconds) {
            const mm = String(Math.floor(seconds / 60)).padStart(2, "0");
            const ss = String(seconds % 60).padStart(2, "0");
            timerDisplay.textContent = `${mm}:${ss}`;
          }

          // --- 18) UI-Hilfsfunktionen ---
          function updateRecordingUI(isActive, isPaused = false) {
            // Aufnahme aktiv
            if (isActive) {
              startBtn.disabled = true;
              stopBtn.disabled = false;
              
              // Pause-Status
              if (isPaused) {
                pauseBtn.disabled = true;
                resumeBtn.disabled = false;
                recordingStatus.innerHTML = '<span class="status-icon">⏸️</span> Aufnahme pausiert';
              } else {
                pauseBtn.disabled = false;
                resumeBtn.disabled = true;
                recordingStatus.innerHTML = '<span class="recording-indicator"></span> Aufnahme läuft';
              }
            } 
            // Aufnahme inaktiv
            else {
              startBtn.disabled = false;
              pauseBtn.disabled = true;
              resumeBtn.disabled = true;
              stopBtn.disabled = true;
              recordingStatus.innerHTML = '';
            }
            
            // Immer dateiname prüfen
            validateFileName();
          }
          
          function showMessage(message, isRecording = false) {
            if (isRecording) {
              uploadStatus.innerHTML = `<span class="recording-indicator"></span> ${message}`;
            } else {
              uploadStatus.textContent = message;
            }
          }
          
          function showError(message) {
            uploadStatus.innerHTML = `<span class="error-message">❌ ${message}</span>`;
            console.error(message);
          }
          
          function showWarning(message) {
            uploadStatus.innerHTML = `<span style="color: #FF9800;">⚠️ ${message}</span>`;
            console.warn(message);
          }
          
          function showSuccess(message) {
            uploadStatus.innerHTML = `<span class="success-message">${message}</span>`;
          }
          
          // --- 19) Lokale Speicherung ---
function saveRecording(blob, mimeType) {
  try {
    // In IndexedDB speichern (vereinfacht mit localStorage)
    localStorage.setItem('lastRecordingMimeType', mimeType);
    
    // Blob als Base64 speichern
    const reader = new FileReader();
    reader.readAsDataURL(blob);
    reader.onloadend = function() {
      const base64data = reader.result;
      localStorage.setItem('lastRecordingData', base64data);
    };
  } catch (err) {
    console.warn("Konnte Aufnahme nicht lokal speichern:", err);
  }
}

// Speichert aktuelle Audiochunks (für Wiederherstellung)
function saveRecordingChunks() {
  // Wir speichern hier nicht die Chunks selbst, da das zu viel wäre
  // Stattdessen markieren wir, dass eine Aufnahme läuft
  if (isRecording) {
    localStorage.setItem('recordingInProgress', 'true');
  }
}

function clearSavedRecording() {
  localStorage.removeItem('lastRecordingData');
  localStorage.removeItem('lastRecordingMimeType');
  localStorage.removeItem('recordingInProgress');
}

function checkForSavedRecording() {
  const savedRecording = localStorage.getItem('lastRecordingData');
  const savedMimeType = localStorage.getItem('lastRecordingMimeType');
  
  if (savedRecording && savedMimeType) {
    // Vorherige Aufnahme wiederherstellen
    try {
      // Base64 in Blob umwandeln
      const byteString = atob(savedRecording.split(',')[1]);
      const ab = new ArrayBuffer(byteString.length);
      const ia = new Uint8Array(ab);
      
      for (let i = 0; i < byteString.length; i++) {
        ia[i] = byteString.charCodeAt(i);
      }
      
      currentRecordingBlob = new Blob([ab], { type: savedMimeType });
      const audioUrl = URL.createObjectURL(currentRecordingBlob);
      audioPlayer.src = audioUrl;
      
      // UI aktualisieren
      uploadBtn.disabled = false;
      showMessage("Gespeicherte Aufnahme geladen. Sie können sie hochladen oder eine neue erstellen.");
    } catch (err) {
      console.warn("Fehler beim Laden der gespeicherten Aufnahme:", err);
      clearSavedRecording();
    }
  }
  
  // Prüfe, ob eine Aufnahme unterbrochen wurde
  const inProgress = localStorage.getItem('recordingInProgress');
  if (inProgress === 'true') {
    showWarning("Eine frühere Aufnahme wurde unterbrochen. Bitte starten Sie eine neue Aufnahme.");
    localStorage.removeItem('recordingInProgress');
  }
}

// --- 20) Hilfsfunktionen ---
function formatBytes(bytes, decimals = 2) {
  if (bytes === 0) return '0 Bytes';
  
  const k = 1024;
  const dm = decimals < 0 ? 0 : decimals;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  
  return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
}
        </script>
      `;
    }
  </script>
</body>
</html>